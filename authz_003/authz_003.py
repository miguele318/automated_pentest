# -*- coding: utf-8 -*-

import os
import time
#from fabrica.otg import OTG

__otg__ =  "OTG-AUTHZ-003"

class AUTHZ_003():

    def __init__(self,url, riesgoNegocio=0.0,dependencia=None):
        
        #super().__init__(dependencia, __otg__)
        self.url = url
        self.ruta = os.getcwd() + "/brutespray-output" 
        self.path_brute = os.getcwd() + "/"
        self.path_namp = "port_scan_" + str(333) + ".gnmap"
        #self.path_output_brute = "port_scan_" + str(333) + ".txt"


    def port_scan(self):
        #print("url que llega:{}".format(self.url))
        os.system("sudo nmap -p 22 " + self.url + " -oG " + self.path_brute + self.path_namp)
        os.system("python2.7 " + self.path_brute + "brutespray.py -f " + self.path_brute + self.path_namp + " -t 5 -T 2 > " +self.ruta + "/output.txt" )
        #time.sleep(60)

    def check_output(self):
        if os.listdir(self.ruta)!=0:
            for archivos in os.listdir(self.ruta):
                print(archivos)
                self.file_read(archivos)
                self.delete_files(archivos)
        else:
            print("No se ecnontraron credenciales")
    
    def file_read(self,archivo):
        with open(self.ruta+"/"+archivo,"r") as file:
            for line in file:
                res = self.remplazar(line)
                print(res)                
                #self.adicionarResultado(res)

    #borrar archivos para nuevas peticiones
    def delete_files(self,archivos):
        os.system("rm -r " + self.ruta + "/" + archivos)


                
    
    def remplazar(self,line):
        find = "ACCOUNT CHECK: [ssh] Host: "
        replace3 = ""
        line1 = line.replace(find,replace3)
        find1 = "(1 of 1, 0 complete) User"
        replace1 = " USUARIO"
        line2 = line1.replace(find1,replace1)
        import re
        n = re.compile(r'\d')
        find11 = "(" +n+" of "+n+", "+n+" complete)"
        replace11 = ""
        line22 = line2.replace(find11,replace11)

        find2 = "Password"
        replace2 = "CONTRASEÃ‘A"
        line3 = line22.replace(find2,replace2)
        return line3
    
    def main(self):
        print("================ Iniciando prueba OTG-AUTHZ-003 ==================\n")
        print("Buscando credenciales para servicios encontrados ...\n")
        self.port_scan()
        self.check_output()
        """if self.detalles.resultado!="":
            self.adicionarRecomendaciones("Cambiar sus credenciales")
            self.calcularRiesgo(__otg__, self.riesgoNegocio)
            self.almacenarBD()
        """


url = "scanme.nmap.org"
#url = "192.168.120.31"
obj = AUTHZ_003(url)
#obj.port_scan()
#obj.check_output()
obj.main()




    




