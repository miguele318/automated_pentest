#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import requests
import shutil
import os
from lxml import etree
from urllib.parse import urlparse


__otg__ = "OTG-CONFIG-008"

class Config_008():
    def __init__(self, url):
        self.url = url
        self.salida = os.getcwd() + "/scrips/"
        self.clientCross = ["clientaccesspolicy.xml", "crossdomain.xml"]
        self.complejidad = 1
        self.resultado = ""
        self.recomendaciones = ""
    
    def peticion(self, url):
        count = 0
        if url[-1] != "/":
            url = url+"/"

        session = requests.Session()
        for xml in self.clientCross:
            req = session.get(url + xml)
            if req.status_code == 200:
                count += 1
                self.resultado += "Archivo <b> %s </b> encontrado." % xml  +"<br />"

                with open(self.salida+ xml, 'wb') as file:
                    file.write(req.content)
                file.close()
        if count > 0:
            return True
        else: return False

    def eliminar_archivos(self):
        for xml in self.clientCross:
            os.system("rm -r " + self.salida+xml)
    
    def obtenerAtributos(self, xml):
        try:
            doc = etree.parse(self.salida+xml)
            contenido = dict()
            if xml == "crossdomain.xml":
                #print("\nExaminando el archivo %s" % xml)
                contenido = doc.find("allow-access-from")
                self.examinar(contenido)
            else:
                pass
            
        except (AttributeError, etree.XMLSyntaxError, OSError):
            return
            
    def examinar(self, contenido):
        for key, value in contenido.items():
            if key == "domain":
                if value == "*":
                    self.recomendaciones += "El atributo 'domain' debe ser cambiado!. Valor actual -> %s" % value +"<br />"
                    

            elif key == "secure":
                if value == "false":
                    self.recomendaciones += "El atributo 'secure' debe ser cambiado!. Valor actual -> %s" % value +"<br />"
                    

            elif key == "to-ports":
                if value == "*":
                    self.recomendaciones += "El atributo 'to-ports' debe ser cambiado!. Valor actual -> %s" % value +"<br />"
            
        if self.recomendaciones == "":
            print(self.recomendaciones)
            self.recomendaciones = "No se identifican fallas de seguridad<br />"

    def reporte(self, id):
        ruta = os.getcwd() + '/informacion/'
        archivo_origen = 'config_008.txt'
        archivo_resultado = 'reportes/config_008_'+str(id)+'.txt'
        
        shutil.copyfile(ruta + archivo_origen, ruta + archivo_resultado)
        with open(ruta + archivo_resultado, 'a') as file:
            file.write('\n' + self.resultado.replace('\n', '<br />'))
            file.write('\n' + self.recomendaciones.replace('\n', '<br />'))


    def main(self, id):
        print("================ Inicio prueba OTG-CONFIG-008 ==================\n")
        if self.peticion(self.url):
            for xml in self.clientCross:
                self.obtenerAtributos(xml)
        else:
            self.resultado = "No se encontrron los archivos <b>{}</b> y <b>{}</b>".format(self.clientCross[0], self.clientCross[1]) + "<br />"
            self.recomendaciones = "No se identifican fallas de seguridad<br />"
        self.eliminar_archivos()
        self.reporte(id)
        print("================ Fin prueba OTG-CONFIG-008 ==================\n")
        
"""
url = "http://testphp.vulnweb.com" #TODO: SOLO URL
a = config_008(url)
a.main()
"""