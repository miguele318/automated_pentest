# usr/bin/env
# -*- coding: utf-8 -*-

import os
import time
import shutil




__otg__ = "OTG-INFO-007"

class Info_007():
    def __init__(self, url):
        
        
        self.ruta = os.getcwd() + "/scrips/INFO_007/"
        self.name = "info_007.xml" 
        self.url = url
        self.resultado = ""
        self.sinResultado = "<br />No fue posible crear el mapas de rutas de ejecución a través de la aplicación<br />"
        self.recomendaciones = ""
        self.numrutas = 0


    def spidering(self, url):
        os.system("python3 " +self.ruta + "main.py --domain " + url + " --output " + self.name + " --verbose")
        time.sleep(2)
    
    def format_file(self):
        crwaler = ""
        with open(self.name) as file:
            for line in file:
                tam = len(line)
                if tam > 3:
                    crwaler += line
                    self.numrutas += 1
        file.close()
        self.delete_file()
        if crwaler != "" :
            self.resultado += "Se identificaron " + str(self.numrutas) + " rutas en su aplicaión."
        else:
            self.resultado = self.sinResultado


    def delete_file(self):
        os.system("rm " +self.name)

    def reporte(self, id):
        ruta = os.getcwd() + '/informacion/'
        archivo_origen = 'info_007.txt'
        archivo_resultado = 'reportes/info_007_'+str(id)+'.txt'
        
        shutil.copyfile(ruta + archivo_origen, ruta + archivo_resultado)
        with open(ruta + archivo_resultado, 'a') as file:
            file.write('\n' + self.resultado.replace('\n', '<br />'))
            file.write('\n' + self.recomendaciones + " ".replace('\n', '<br />'))

    def main(self, id):
        print("================ Iniciando prueba OTG-INFO-007 ==================\n")
        url =self.url
        self.spidering(url)
        self.format_file()

        
        self.recomendaciones = "Evite colocar su sitemap en el archivo robots.txt"
        self.reporte(id)
           
        print("================ Fin de la  prueba OTG-INFO-007 ==================\n")
        
        








"""url = "http://testphp.vulnweb.com/"  #TODO:SOLO URL

#url = "https://blog.lesite.us"
obj = info_007(url)
# #url = "http://www.unicauca.edu.co/versionP/"
obj.main()"""
