# -*- coding: utf-8 -*-
import os


#Descripción = Esta prueba es útil para realizar ataques de fuerza bruta, al encontrar posibles usuarios que esten registrados en la aplicación web, en la que el probador verifica si, dado un nombre de usuario válido para analizar si
#es posible encontrar la contraseña correspondiente.

#Objetivo: El alcance de esta prueba es verificar si es posible recolectar un conjunto
# de nombres de usuario válidos para interactuar con el mecanismo de autenticación

__otg__ = "OTG-IDENT-004"

#A2

class ident_004():

    def __init__(self,dominio):
        self.dominio = dominio
        self.ruta = os.getcwd() + "/"
        #id_tmp = self.pentest.id()
        #id = str(id_tmp)
        self.name = "iden_004_" +str(4)+".txt"
        self.resultados = ""

    def search_user(self):
        os.system("theHarvester -d " + self.dominio + " -b all > " + self.ruta+self.name)
    
    def read_file(self):
        correos =""
        with open (self.ruta + self.name,"r") as file:
            for line in file:
                if "@" in line and "cmartorella@edge-security.com" not in line:
                    correos += line
        file.close()
        
        print(correos)
        self.add_outcomes(correos)

    def add_outcomes(self,correos):

        if correos != "":
            self.resultados += correos
        else:
            print("No se han encontrado usuarios para la aplicación web {}".format(self.dominio))
    
    def delete_file(self):
        os.system("rm -r " + self.ruta+self.name)
        
      
    def main(self):
        print("================ Iniciando prueba OTG-IDENT-004 ==================\n")
        print("Encontrando usuario para {}".format(self.dominio))
        self.search_user()
        self.read_file()
        """if self.detalles.resultado !="":
            
            recomendación1 = "Asegurarse que la aplicación devuelva mensajes de error genéricos cuando se ingresen credenciales de usuario no válidas durante el proceso de inicio de sesión"
            recomentación2 = "Verifique que las cuentas predeterminadas del sistema y las cuentas de prueba se eliminen antes de liberar el sistema a producción o exponerlo a una red que no es de confianza"
            self.adicionarRecomendaciones(recomendación1)
            self.adicionarRecomendaciones(recomentación2)
            self.calcularRiesgo(__otg__, self.riesgoNegocio)
            
            self.almacenarBD()"""
        self.delete_file()
        
        print("================ Fin prueba OTG-IDENT-004 ==================\n")

dominio = "facebook.com"  #TODO: DOMINIO
#url = "http://testphp.vulnweb.com/"
#dominio = "testphp.vulnweb.com"
ip = "18.192.172.30"
test=ident_004(dominio)
test.main()