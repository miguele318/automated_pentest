# -*- coding: utf-8 -*-
import os
import shutil


class Ident_004():

    def __init__(self,dominio):
        self.dominio = dominio
        self.ruta = os.getcwd() + "/scrips/"
        self.name = "iden_004.txt"
        self.resultados = ""
        self.recomendaciones = ""
        self.numcorreos = 0

    def search_user(self):
        os.system("theHarvester -d " + self.dominio + " -b all > " + self.ruta+self.name)
    
    def read_file(self):
        correos =""
        with open (self.ruta + self.name,"r") as file:
            for line in file:
                if "@" in line and "cmartorella@edge-security.com" not in line:
                    correos += line
                    self.numcorreos += 1
        file.close()
        
        print(correos)
        self.add_outcomes(correos)

    def add_outcomes(self,correos):

        if self.numcorreos != 0:
            self.resultados = "- Se han identificado "+ self.numcorreos + " cuentas asociadas a la aplicacion web."
        else:
            self.resultados = "- No se han encontrado usuarios para la aplicación web {}".format(self.dominio)
    
    def delete_file(self):
        os.system("rm -r " + self.ruta+self.name)

    def reporte(self, id):
        ruta = os.getcwd() + '/informacion/'
        archivo_origen = 'ident_004.txt'
        archivo_resultado = 'reportes/ident_004_'+str(id)+'.txt'
        
        shutil.copyfile(ruta + archivo_origen, ruta + archivo_resultado)
        with open(ruta + archivo_resultado, 'a') as file:
            file.write('\n' + self.resultados.replace('\n', '<br />'))
            file.write('\n' + self.recomendaciones.replace('\n', '<br />'))
        
      
    def main(self, id):
        print("================ Iniciando prueba OTG-IDENT-004 ==================\n")
        print("Encontrando usuario para {}".format(self.dominio))
        self.search_user()
        self.read_file()
        
            
        recomendación1 = "- Asegurarse que la aplicación devuelva mensajes de error genéricos cuando se ingresen credenciales de usuario no válidas durante el proceso de inicio de sesión.<br />"
        recomentación2 = "- Verifique que las cuentas predeterminadas del sistema y las cuentas de prueba se eliminen antes de liberar el sistema a producción o exponerlo a una red que no es de confianza.<br />"
        self.recomendaciones += recomendación1
        self.recomendaciones += recomentación2
        
        self.delete_file()
        self.reporte(id)
        
        print("================ Fin prueba OTG-IDENT-004 ==================\n")
        

"""dominio = "facebook.com"  #TODO: DOMINIO
#url = "http://testphp.vulnweb.com/"
#dominio = "testphp.vulnweb.com"
ip = "18.192.172.30"
test=ident_004(dominio)
test.main()"""