#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import requests
import time
from urllib.parse import urlparse
#from fabrica.otg import OTG

__otg__ = "OTG-CONFIG-007"

class Config_007():
    def __init__(self, url):
        #super().__init__(dependencia, __otg__, riesgoNegocio)
        self.url = url
        self.complejidad = 1
        self.resultado = ""
        self.recomendaciones = ""
        
    def verificarHSTS(self):

        r = requests.head(self.url)
        codigo_respuesta = r.status_code
        self.resultado +=("\nCódigo de respuesta: " + str(codigo_respuesta))

        codigos = [200, 301, 302, 403]

        if codigo_respuesta in codigos:

            try:
                cabecera = 'Strict-Transport-Security'
                self.resultado += ("\nBuscando la cabecera HSTS (Strict-Transport-Security)")
                time.sleep(1)

                sts = r.headers[cabecera]
                self.recomendaciones = ("\nCabecera HSTS encontrada!\n'%s' : %s\n" % (cabecera, sts) + "Asegurece de mantener la configuración para que su información sea transportada de forma segura.")
            except KeyError:
                self.recomendaciones = "\nHSTS no encontrado.\nLa información puede navegar en texto plano, asegurece de configurar su aplicación para que la informacion sea cifrada antes de ser enviada."
                
        else:
                self.resultado = "Hubo un problema en establecer la comunicación.\nCódigo : %s.\n" % codigo_respuesta
    
    def main(self):
        print("================ Inicio prueba OTG-CONFIG-007 ==================\n")
        u = urlparse(self.url)
        self.url = u.scheme + "://" + u.netloc + u.path
        self.verificarHSTS()

        print("================ Fin prueba OTG-CONFIG-007 ==================\n")
        return self.resultado, self.recomendaciones


"""# url = "https://github.com/"
#url = "https://simca.unicauca.edu.co/simca/"
url="http://scanme.nmap.org/"  #TODO: SOLO URL

c = config_007(url)
c.main()
"""