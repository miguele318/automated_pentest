# -*- coding: utf-8 -*-

import os
import time
#from fabrica.otg import OTG

__otg__ =  "OTG-AUTHZ-003"

class Authz_003():

    def __init__(self,dominio):
        
        #super().__init__(dependencia, __otg__)
        self.dominio = dominio
        self.ruta = os.getcwd() + "/scrips/AUTHZ_003/brutespray-output" 
        self.path_brute = os.getcwd() + "/scrips/AUTHZ_003/"
        self.path_namp = "port_scan_" + str(333) + ".gnmap"
        #self.path_output_brute = "port_scan_" + str(333) + ".txt"


    def port_scan(self):
        #print("url que llega:{}".format(self.url))
        os.system("sudo nmap -p 22 " + self.dominio + " -oG " + self.path_brute + self.path_namp)
        os.system("python2.7 " + self.path_brute + "brutespray.py -f " + self.path_brute + self.path_namp + " -t 5 -T 2 > " +self.ruta + "/output.txt" )
        #time.sleep(60)

    def check_output(self):
        if os.listdir(self.ruta)!=0:
            for archivos in os.listdir(self.ruta):
                print(archivos)
                self.file_read(archivos)
                self.delete_files(archivos)
        else:
            print("No se encontraron credenciales")
    
    def file_read(self,archivo):
        

        res=""

        
        f = open(self.ruta+"/"+archivo, "r")
        count = 0
        lineas = f.readlines() 
        for line in lineas:
            if count < 5:
                count+=1
                continue
            res = self.remplazar(line)
            print(res)                
            #self.adicionarResultado(res)
        f.close()

    #borrar archivos para nuevas peticiones
    def delete_files(self,archivos):
        os.system("rm -r " + self.ruta + "/" + archivos)


                
    
    def remplazar(self,line):
        find="Loading File: |servicio en brute: ssh"
        replace=""
        line=line.replace(find,replace)
        find="<built-in method readline of file object at 0x7fc2d0e73d20>"
        replace=""
        line=line.replace(find,replace)
        find="Medusa v2.2 [http://www.foofus.net] (C) JoMo-Kun / Foofus Networks <jmk@foofus.net>"
        replace=""
        line=line.replace(find,replace)
        find = "ACCOUNT CHECK"
        replace3 = "CUENTA VERIFICADA"
        line1 = line.replace(find,replace3)
        find1 = "(1 of 1, 0 complete) User"
        replace1 = " USUARIO"
        line2 = line1.replace(find1,replace1)
        find2 = "Password"
        replace2 = "CONTRASEÃ‘A"
        line3 = line2.replace(find2,replace2)
        return line3
    
    def main(self):
        print("================ Iniciando prueba OTG-AUTHZ-003 ==================\n")
        print("Buscando credenciales para servicios encontrados ...\n")
        self.port_scan()
        self.check_output()
        """if self.detalles.resultado!="":
            self.adicionarRecomendaciones("Cambiar sus credenciales")
            self.calcularRiesgo(__otg__, self.riesgoNegocio)
            self.almacenarBD()
        """


"""dominio = "scanme.nmap.org" #TODO:  DOMINIO o IP
obj = authz_003(dominio)
#obj.port_scan()
#obj.check_output()
obj.main()
"""



    




